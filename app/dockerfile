# Generated by ChatGPT
# -------- STAGE 1: Build (compile TS to JS) --------
FROM node:22.20.0-alpine AS builder

# Cài dependencies (cả dev để compile)
WORKDIR /opt/app

COPY package.json ./
RUN npm install

COPY tsconfig.json ./
COPY src ./src

# Compile TS sang JS (ra thư mục build)
RUN ["npm", "run", "build"]

# -------- STAGE 2: Runtime (chỉ chứa code đã build) --------
FROM node:22.20.0-alpine AS runner

WORKDIR /opt/app

# Chỉ copy package.json để cài prod dependencies
COPY package*.json ./

# Cài dependencies prod-only
RUN npm install --omit=dev

# Copy build đã build sang
COPY --from=builder /opt/app/build ./build

# Copy các file cấu hình nếu cần
COPY .env ./

CMD ["npm", "run", "start:dev-express"]
